<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>パズドラ アシスト検討応援ツール</title>
  <meta name="description" content="パズドラの最適なアシストモンスターの組み合わせを提案するツール。覚醒スキル条件やスキブ数を指定して、最適なアシストを自動計算。">
  <link rel="stylesheet" href="style.css">
</head>

<body>

  <!-- Opening Animation overlay -->
  <div id="opening-animation">
    <div class="animation-container">
      <svg viewBox="0 0 400 300" class="opening-svg">
        <defs>
          <linearGradient id="rainbow-grad" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:#ff5f5f" />
            <stop offset="20%" style="stop-color:#ffbd5f" />
            <stop offset="40%" style="stop-color:#fff15f" />
            <stop offset="60%" style="stop-color:#5fff7d" />
            <stop offset="80%" style="stop-color:#5fb8ff" />
            <stop offset="100%" style="stop-color:#b85fff" />
          </linearGradient>
        </defs>
        <!-- 6つの四角い枠 (①) -->
        <g class="slots-group">
          <rect x="50" y="100" width="40" height="40" rx="4" class="slot-rect" />
          <rect x="105" y="100" width="40" height="40" rx="4" class="slot-rect" />
          <rect x="160" y="100" width="40" height="40" rx="4" class="slot-rect" />
          <rect x="215" y="100" width="40" height="40" rx="4" class="slot-rect" />
          <rect x="270" y="100" width="40" height="40" rx="4" class="slot-rect" />
          <rect x="325" y="100" width="40" height="40" rx="4" class="slot-rect" />
        </g>

        <!-- 6つの虹色四角 (②) -->
        <g class="rainbow-group">
          <rect x="50" y="400" width="40" height="40" rx="4" class="rainbow-rect r1" />
          <rect x="105" y="400" width="40" height="40" rx="4" class="rainbow-rect r2" />
          <rect x="160" y="400" width="40" height="40" rx="4" class="rainbow-rect r3" />
          <rect x="215" y="400" width="40" height="40" rx="4" class="rainbow-rect r4" />
          <rect x="270" y="400" width="40" height="40" rx="4" class="rainbow-rect r5" />
          <rect x="325" y="400" width="40" height="40" rx="4" class="rainbow-rect r6" />
        </g>

        <!-- 弾けるエフェクト用のパーティクル (③) -->
        <g class="burst-group" id="burst-particles"></g>

        <!-- タイトル表示 (③) -->
        <text x="200" y="200" text-anchor="middle" class="opening-title">アシスト検討応援ツール</text>
      </svg>
    </div>
  </div>

  <!-- Loading Overlay (Initial hidden, will be managed by app.js) -->
  <div id="loading-overlay" style="display: none;">
    <div class="loading-spinner"></div>
    <div class="loading-text">データを読み込み中...</div>
  </div>

  <!-- Header -->
  <header class="app-header">
    <h1 class="app-title">🐲 アシスト検討応援ツール</h1>
    <p class="app-subtitle">パーティに最適なアシストの組み合わせを見つけよう</p>
    <div class="info-btn-wrapper" id="btn-show-info" title="取扱説明書を見る">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
        stroke-linejoin="round" class="info-svg">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="16" x2="12" y2="12"></line>
        <line x1="12" y1="8" x2="12.01" y2="8"></line>
      </svg>
    </div>
  </header>

  <!-- Step Indicator -->
  <nav class="step-indicator" id="step-indicator">
    <div class="step-dot active" data-step="0">0</div>
    <div class="step-line" data-line="0"></div>
    <div class="step-dot" data-step="1">1</div>
    <div class="step-line" data-line="1"></div>
    <div class="step-dot" data-step="2">2</div>
    <div class="step-line" data-line="2"></div>
    <div class="step-dot" data-step="3">3</div>
    <div class="step-line" data-line="3"></div>
    <div class="step-dot" data-step="4">R</div>
  </nav>

  <main class="app-container">

    <!-- ===== STEP 0: ベースモンスター指定 ===== -->
    <div class="step-panel active" id="step-0">
      <div class="section-card">
        <div class="section-title"><span class="emoji">👤</span> STEP 0: ベースモンスターの指定</div>
        <p class="section-desc">パーティの6体のベースモンスターを指定してください。番号または名前で検索できます。（任意：指定しなくても次のステップに進めます）</p>
        <div class="slot-tabs" id="base-slot-tabs">
          <div class="slot-tab active" data-slot="0">スロット1</div>
          <div class="slot-tab" data-slot="1">スロット2</div>
          <div class="slot-tab" data-slot="2">スロット3</div>
          <div class="slot-tab" data-slot="3">スロット4</div>
          <div class="slot-tab" data-slot="4">スロット5</div>
          <div class="slot-tab" data-slot="5">スロット6</div>
        </div>
        <div id="base-slot-contents"></div>
      </div>
      <div class="step-nav">
        <div></div>
        <button class="btn btn-primary" onclick="goToStep(1)">次へ ▶</button>
      </div>
    </div>

    <!-- ===== STEP 1: 個別条件指定 ===== -->
    <div class="step-panel" id="step-1">
      <!-- ベースモンスター情報表示エリア -->
      <div id="step1-base-summary"></div>

      <div class="section-card">
        <div class="section-title"><span class="emoji">⚙️</span> STEP 1: スロット別アシスト条件</div>
        <p class="section-desc">各スロットのアシストに対する条件を設定します。必須覚醒、属性/タイプ条件、スキル使用可否を指定してください。</p>
        <div class="slot-tabs" id="cond-slot-tabs">
          <div class="slot-tab active" data-slot="0">スロット1</div>
          <div class="slot-tab" data-slot="1">スロット2</div>
          <div class="slot-tab" data-slot="2">スロット3</div>
          <div class="slot-tab" data-slot="3">スロット4</div>
          <div class="slot-tab" data-slot="4">スロット5</div>
          <div class="slot-tab" data-slot="5">スロット6</div>
        </div>
        <div id="cond-slot-contents"></div>
      </div>
      <div class="step-nav">
        <button class="btn btn-outline" onclick="goToStep(0)">◀ 戻る</button>
        <button class="btn btn-primary" onclick="goToStep(2)">次へ ▶</button>
      </div>
    </div>

    <!-- ===== STEP 2: 火力覚醒の選択 ===== -->
    <div class="step-panel" id="step-2">
      <!-- 前ステップの条件表示エリア -->
      <div id="step2-prev-summary"></div>

      <div class="section-card">
        <div class="section-title"><span class="emoji">🔥</span> STEP 2: 有効な火力覚醒の選択</div>
        <p class="section-desc">このパーティで有効活用できる火力覚醒を選択してください。＋付き覚醒は元覚醒の選択で自動的に含まれます。</p>
        <div class="field-label">火力覚醒一覧（タップで選択/解除）</div>
        <div class="icon-grid" id="dps-awakens-grid"></div>
        <div class="field-label" style="margin-top:12px">選択中の火力覚醒（タップで解除）：</div>
        <div class="selected-conditions" id="selected-dps-awakens">
          <span style="color:var(--text-muted);font-size:0.8rem">まだ選択されていません</span>
        </div>
      </div>
      <div class="step-nav">
        <button class="btn btn-outline" onclick="goToStep(1)">◀ 戻る</button>
        <button class="btn btn-primary" onclick="goToStep(3)">次へ ▶</button>
      </div>
    </div>

    <!-- ===== STEP 3: パーティ全体条件 ===== -->
    <div class="step-panel" id="step-3">
      <div class="section-card">
        <div class="section-title"><span class="emoji">🎯</span> STEP 3: パーティ全体で必要な覚醒</div>
        <p class="section-desc">アシスト6体合計で欲しい覚醒の種類と個数を指定してください。アイコンをタップするたび数量が増加します。右クリックまたは長押しで減少します。</p>
        <div class="field-label">覚醒スキル（タップで追加）</div>
        <div class="icon-grid" id="party-awakens-grid"></div>
        <div class="field-label" style="margin-top:12px">指定中の必要覚醒（タップで1つ減らす）：</div>
        <div class="selected-conditions" id="party-required-display">
          <span style="color:var(--text-muted);font-size:0.8rem">まだ指定されていません</span>
        </div>
      </div>
      <div class="section-card">
        <div class="section-title"><span class="emoji">⚡</span> スキルブースト設定</div>
        <p class="section-desc">※アシストモンスターのみで補う必要があるスキルブースト合計数を入力してください</p>
        <div class="num-input-group">
          <label>必要スキブ合計：</label>
          <input type="number" class="num-input" id="required-sb" min="0" value="0">
          <span style="font-size:0.82rem;color:var(--text-muted)">ターン</span>
        </div>
        <div class="toggle-row">
          <span class="toggle-label">遅延をスキブに加算する</span>
          <label class="toggle-switch">
            <input type="checkbox" id="delay-as-sb">
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
      <div class="step-nav">
        <button class="btn btn-outline" onclick="goToStep(2)">◀ 戻る</button>
        <button class="btn btn-gold btn-lg" id="btn-optimize" onclick="runOptimization()">🔍 この条件で検索</button>
      </div>
    </div>

    <!-- ===== STEP 4: 結果表示 ===== -->
    <div class="step-panel" id="step-4">
      <div id="search-status-warning"></div>

      <!-- 火力覚醒スイッチ（候補なし時用） -->
      <div id="dps-toggle-section" style="display:none; margin-bottom:12px;">
        <div class="section-card" style="border: 2px solid var(--accent-red);">
          <div class="section-title"><span class="emoji">🚨</span> 条件を緩める</div>
          <p class="section-desc">候補が見つかりませんでした。火力優先条件を一時的にOFFにして再検索できます。</p>
          <div id="dps-priority-toggles-container"></div>
        </div>
      </div>

      <!-- 計算進捗セクション -->
      <div id="calc-progress-section" style="display:none">
        <div class="progress-card">
          <div class="progress-status" id="progress-status">計算中...</div>
          <div class="progress-bar-wrap">
            <div class="progress-bar-inner" id="progress-bar-inner"></div>
          </div>
          <button class="btn btn-danger" onclick="stopOptimization()">⏹ 計算を止める</button>
        </div>
      </div>

      <!-- 固定モンスター管理セクション -->
      <div id="pinned-section" style="display:none">
        <div class="section-card" style="border:2px solid var(--accent-gold)">
          <div class="section-title"><span class="emoji">📌</span> 固定済みアシスト</div>
          <div id="pinned-list"></div>
          <div style="margin-top:10px;text-align:right">
            <button class="btn btn-outline btn-sm" onclick="clearAllPins()">全固定を解除して再計算</button>
          </div>
        </div>
      </div>

      <div class="section-card">
        <div class="section-title"><span class="emoji">🏆</span> 組み合わせ候補</div>
        <p class="section-desc" id="result-desc"></p>
        <!-- ベースモンスター表示 -->
        <div id="result-base-display"></div>
        <!-- 結果パターン -->
        <div id="result-container"></div>
      </div>

      <!-- ブックマークセクション (折りたたみ) -->
      <div class="section-card" id="bookmark-section" style="display:none">
        <details>
          <summary class="section-title"
            style="cursor:pointer; outline:none; list-style:none; display:flex; align-items:center;">
            <span class="emoji">🔖</span> ブックマーク済みの候補
            <span id="bookmark-count"
              style="margin-left:auto; font-size:0.8rem; background:var(--accent-gold); color:var(--bg-main); padding:2px 8px; border-radius:10px;">0</span>
          </summary>
          <div id="bookmark-list-container" style="margin-top:12px"></div>
        </details>
      </div>

      <!-- 除外リスト管理 -->
      <div class="section-card" id="exclusion-manager-section" style="display:none">
        <div class="section-title"><span class="emoji">🚫</span> 除外済みモンスターの管理</div>
        <div class="exclusion-list" id="exclusion-list-container"></div>
        <div style="margin-top:12px; text-align:right">
          <button class="btn btn-outline btn-sm" onclick="clearAllExclusions()">全ての除外を解除</button>
        </div>
      </div>

      <div class="step-nav">
        <button class="btn btn-outline" onclick="goToStep(3)">◀ 条件を変更</button>
        <div style="display: flex; flex-direction: column; align-items: flex-end; max-width: 60%; text-align: right;">
          <span
            style="font-size:0.75rem; color:var(--text-muted); margin-bottom:8px;">※3体程度固定化した上で再計算するとより精度が上がりますが、時間がかかります（4体固定推奨）</span>
          <button class="btn btn-primary" id="btn-recalc" onclick="runOptimization()" style="display:none">🔄
            除外して再計算</button>
        </div>
      </div>
    </div>

  </main>

  <!-- フローティングアクションボタン (FAB) -->
  <div class="fab-container left" id="fab-bookmarks" style="display:none" onclick="toggleBookmarkOverlay()"
    title="ブックマークを確認">
    <div class="fab-btn bookmark-btn">
      <svg class="icon-svg" viewBox="0 0 24 24">
        <path d="M17,3H7C5.9,3,5,3.9,5,5v16l7-3l7,3V5C19,3.9,18.1,3,17,3z"></path>
      </svg>
      <span class="fab-label">ブックマーク済み</span>
    </div>
  </div>

  <div class="fab-container right" id="fab-recalc" style="display:none" onclick="runOptimization()" title="除外して再計算">
    <div class="fab-btn recalc-btn">
      <svg class="icon-svg" viewBox="0 0 24 24">
        <path
          d="M17.65,6.35C16.2,4.9,14.21,4,12,4c-4.42,0-7.99,3.58-7.99,8s3.57,8,7.99,8c3.73,0,6.84-2.55,7.73-6h-2.08 c-0.82,2.33-3.04,4-5.65,4c-3.31,0-6-2.69-6-6s2.69-6,6-6c1.66,0,3.14,0.69,4.22,1.78L13,11h7V4L17.65,6.35z">
        </path>
      </svg>
      <span class="fab-label">再計算</span>
    </div>
  </div>

  <!-- Bookmark Overlay Modal -->
  <div id="bookmark-modal-overlay" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 95%; width: 900px;">
      <div class="modal-header">
        <h2>🔖 ブックマーク済みの組み合わせ</h2>
        <span class="modal-close" onclick="toggleBookmarkOverlay()">&times;</span>
      </div>
      <div class="modal-body">
        <div id="bookmark-modal-list"></div>
        <div id="bookmark-empty-msg" style="text-align:center; padding:40px; color:var(--text-muted);">
          ブックマークされた組み合わせはありません。
        </div>
      </div>
    </div>
  </div>

  <!-- Info Modal Overlay -->
  <div id="info-modal-overlay" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2>取扱説明書</h2>
        <span class="modal-close" id="btn-close-info">&times;</span>
      </div>
      <div class="modal-body">
        <pre id="info-text-content">読み込み中...</pre>
      </div>
    </div>
  </div>

  <footer style="text-align:right;padding:8px 16px;font-size:0.7rem;color:#666;opacity:0.6;">
    v1.0.2 / 最終修正: 2026-02-26
  </footer>

  <script src="app.js"></script>
</body>

</html>